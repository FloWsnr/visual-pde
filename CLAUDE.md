# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

VisualPDE is an interactive browser-based simulator for solving partial differential equations (PDEs). It combines Jekyll static site generation with GPU-accelerated real-time numerical simulations using WebGL/Three.js.

**Live site**: https://visualpde.com

## Build & Development Commands

### Local Development
```bash
# Serve locally (requires Ruby 3.1.x)
bundle exec jekyll serve
# Site available at http://localhost:4000
```

### Build Pipeline Components
The full build runs via GitHub Actions (`.github/workflows/build-and-deploy.yaml`) in this order:

1. **Format RD files**: `npx prettier --write ./sim/scripts/RD/*.js`
2. **Build doc index**: `cd assets/js/build_index && npm install && node build_index.js`
3. **Minify JS**: `terser --compress --mangle --keep-classnames --module` on `./sim/scripts/`
4. **Webpack bundle**: `cd sim/scripts/RD && npx webpack`
5. **Minify CSS**: `cleancss` on all CSS files
6. **Build URL lookup**: `cd assets && python build_url_lookup.py`
7. **Jekyll build**: `jekyll build`

### Running Individual Build Steps Locally
```bash
# Rebuild doc index (after adding/modifying content markdown)
cd assets/js/build_index && npm install && node build_index.js

# Bundle RD simulation code (after modifying sim/scripts/RD/)
cd sim/scripts/RD && npx webpack
```

## Architecture

### Core Simulation Engine (`sim/scripts/RD/`)
- **main.js** - Entry point, ES module bundled by Webpack
- **presets.js** - Preset PDE configurations
- **simulation_shaders.js** - GLSL shaders for PDE solving
- **display_shaders.js** - Visualization shaders (colormaps, contours)
- **drawing_shaders.js** - User input/drawing shaders
- **post_shaders.js** - Post-processing effects

The simulation uses GPU-accelerated GLSL shaders with Three.js. Simulation state is stored in WebGL textures, updated each timestep by shaders, then rendered to canvas.

### Jekyll Site Structure
- **`_layouts/`** - HTML templates (sim.html is the main simulation page)
- **`_includes/`** - Reusable HTML partials
- **`_*-pdes/`** - Content collections (basic-pdes, art-pdes, mathematical-biology, etc.)
- **`_user-guide/`** - Documentation pages
- **`_visual-stories/`** - Educational narrative content

### Key Libraries
- **Three.js** - 3D rendering and WebGL abstraction
- **dat.gui** - UI control panels
- **expr-eval** - Math expression parsing
- **lz-string** - URL parameter compression (simulation configs are stored compressed in URLs)
- **MathJax** - LaTeX math rendering
- **Lunr.js** - Client-side search

### Content System
All simulation content is markdown with YAML front-matter defining equations, parameters, thumbnails, and categories. The build system (`assets/js/build_index/build_index.js`) scans all markdown to generate searchable indexes (`doclist.json`, `doclist_frontmatter.json`).

### URL Shortening
Long simulation URLs are compressed with lz-string. Short codes map to full URLs via files in `/assets/m/` generated by `assets/build_url_lookup.py` from `assets/urls.json`.

## Technology Stack

- **Frontend**: Three.js, GLSL shaders, dat.gui, jQuery
- **Static Site**: Jekyll 4.3.3 with Minima theme
- **Build**: Webpack, Terser, clean-css, Prettier
- **Runtime**: Pure client-side (no backend), PWA with service worker
- **Deploy**: GitHub Pages

## Key Files

- `_config.yml` - Jekyll configuration and collection definitions
- `sim/scripts/RD/webpack.config.js` - Webpack bundling config
- `manifest.json` - PWA manifest
- `.htaccess` - Caching rules (1yr JS/CSS, 4mo images)
